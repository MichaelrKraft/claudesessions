#!/bin/bash
# Claude Code Session Browser v2.0
# Browse, search, and view archived Claude Code sessions
# Now with SQLite full-text search!

ARCHIVE_DIR="$HOME/.claude/session-archives"
DB_FILE="$ARCHIVE_DIR/sessions.db"

# Determine script directory for finding related files
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Try project directory first (for development), then installed location
if [ -f "$PROJECT_DIR/bin/db-manager.sh" ]; then
    DB_MANAGER="$PROJECT_DIR/bin/db-manager.sh"
else
    DB_MANAGER="$HOME/.claudesessions/bin/db-manager.sh"
fi

if [ -f "$PROJECT_DIR/lib/credits.sh" ]; then
    CREDITS_LIB="$PROJECT_DIR/lib/credits.sh"
else
    CREDITS_LIB="$HOME/.claudesessions/lib/credits.sh"
fi

# Source credits library if available
if [ -f "$CREDITS_LIB" ]; then
    source "$CREDITS_LIB"
fi

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Ensure database exists
ensure_db() {
    if [ ! -f "$DB_FILE" ]; then
        echo -e "${YELLOW}Initializing session database...${NC}"
        "$DB_MANAGER" init
        "$DB_MANAGER" reindex
    fi
}

# === COMMANDS ===

cmd_list() {
    echo -e "${BLUE}${BOLD}=== Archived Sessions ===${NC}"
    echo ""
    
    if [ ! -d "$ARCHIVE_DIR" ] || [ -z "$(ls -A "$ARCHIVE_DIR" 2>/dev/null | grep -v sessions.db)" ]; then
        echo "No archived sessions found."
        echo "Sessions will be archived automatically when you exit Claude Code."
        echo "Or use /checkpoint to save manually."
        return
    fi
    
    ensure_db
    
    # Use SQLite for listing if available
    if [ -f "$DB_FILE" ]; then
        sqlite3 -separator '|' "$DB_FILE" "
            SELECT archive_name, archived_at, user_messages, tool_calls, substr(preview, 1, 60)
            FROM sessions ORDER BY archived_at DESC LIMIT 20;
        " | while IFS='|' read -r name date msgs tools preview; do
            echo -e "${GREEN}${BOLD}$name${NC}"
            echo -e "  ${CYAN}Date:${NC} $date"
            echo -e "  ${CYAN}Messages:${NC} $msgs user | ${CYAN}Tools:${NC} $tools calls"
            echo -e "  ${CYAN}Preview:${NC} ${preview}..."
            echo ""
        done
    else
        # Fallback to file-based listing
        for session_dir in "$ARCHIVE_DIR"/*/; do
            if [ -d "$session_dir" ]; then
                session_name=$(basename "$session_dir")
                metadata="$session_dir/metadata.json"
                
                if [ -f "$metadata" ]; then
                    archived_at=$(jq -r '.archived_at // "unknown"' "$metadata")
                    user_msgs=$(jq -r '.stats.user_messages // 0' "$metadata")
                    tool_calls=$(jq -r '.stats.tool_calls // 0' "$metadata")
                    preview=$(jq -r '.preview // ""' "$metadata" | head -c 60)
                    
                    echo -e "${GREEN}$session_name${NC}"
                    echo "  Date: $archived_at"
                    echo "  Messages: $user_msgs | Tools: $tool_calls"
                    echo "  Preview: ${preview}..."
                    echo ""
                fi
            fi
        done | head -80
    fi
}

cmd_search() {
    query="$1"
    if [ -z "$query" ]; then
        echo "Usage: sessions search <query>"
        echo "Example: sessions search 'React component'"
        return 1
    fi
    
    ensure_db
    
    echo -e "${BLUE}${BOLD}=== Searching: $query ===${NC}"
    echo ""
    
    if [ -f "$DB_FILE" ]; then
        # Use FTS search
        results=$(sqlite3 -separator '|' "$DB_FILE" "
            SELECT s.archive_name, s.archived_at, s.user_messages, substr(s.preview, 1, 80)
            FROM sessions s
            JOIN sessions_fts fts ON s.id = fts.rowid
            WHERE sessions_fts MATCH '\"$query\"' OR sessions_fts MATCH '$query*'
            ORDER BY s.archived_at DESC
            LIMIT 15;
        " 2>/dev/null)
        
        if [ -z "$results" ]; then
            # Fallback to LIKE search
            results=$(sqlite3 -separator '|' "$DB_FILE" "
                SELECT archive_name, archived_at, user_messages, substr(preview, 1, 80)
                FROM sessions
                WHERE preview LIKE '%$query%' OR summary LIKE '%$query%'
                ORDER BY archived_at DESC
                LIMIT 15;
            ")
        fi
        
        if [ -z "$results" ]; then
            echo "No sessions found matching '$query'"
            return
        fi
        
        count=0
        echo "$results" | while IFS='|' read -r name date msgs preview; do
            echo -e "${GREEN}${BOLD}$name${NC}"
            echo -e "  ${CYAN}Date:${NC} $date | ${CYAN}Messages:${NC} $msgs"
            echo -e "  ${CYAN}Preview:${NC} ${preview}..."
            echo ""
            count=$((count + 1))
        done
        
        total=$(echo "$results" | wc -l | tr -d ' ')
        echo -e "${BLUE}Found $total session(s) matching '$query'${NC}"
    else
        # Fallback to grep
        found=0
        for transcript in "$ARCHIVE_DIR"/*/transcript.jsonl; do
            if [ -f "$transcript" ] && grep -qi "$query" "$transcript" 2>/dev/null; then
                session_dir=$(dirname "$transcript")
                session_name=$(basename "$session_dir")
                echo -e "${GREEN}Found in: $session_name${NC}"
                grep -i --color=always "$query" "$transcript" | head -3
                echo ""
                found=$((found + 1))
            fi
        done
        
        if [ $found -eq 0 ]; then
            echo "No sessions found matching '$query'"
        else
            echo -e "${BLUE}Found $found session(s)${NC}"
        fi
    fi
}

cmd_view() {
    session="$1"
    if [ -z "$session" ]; then
        echo "Usage: sessions view <session-name>"
        echo "Use 'sessions list' to see available sessions"
        return 1
    fi
    
    session_dir="$ARCHIVE_DIR/$session"
    
    # Try exact match first, then partial
    if [ ! -d "$session_dir" ]; then
        matches=$(ls -d "$ARCHIVE_DIR"/*"$session"* 2>/dev/null | head -1)
        if [ -n "$matches" ]; then
            session_dir="$matches"
            session=$(basename "$session_dir")
        else
            echo "Session not found: $session"
            return 1
        fi
    fi
    
    echo -e "${BLUE}${BOLD}=== Session: $session ===${NC}"
    echo ""
    
    # Show summary if available
    if [ -f "$session_dir/summary.txt" ]; then
        echo -e "${CYAN}${BOLD}AI Summary:${NC}"
        cat "$session_dir/summary.txt"
        echo ""
    fi
    
    # Show metadata
    if [ -f "$session_dir/metadata.json" ]; then
        echo -e "${CYAN}${BOLD}Details:${NC}"
        jq -r '"  Archived: \(.archived_at)\n  Directory: \(.working_directory)\n  Messages: \(.stats.user_messages) user, \(.stats.assistant_messages) assistant\n  Tool calls: \(.stats.tool_calls)\n  Tools: \(.tools_used // \"none\")"' "$session_dir/metadata.json"
        echo ""
    fi
    
    # Show preview
    if [ -f "$session_dir/metadata.json" ]; then
        echo -e "${CYAN}${BOLD}First Message:${NC}"
        jq -r '.preview // "No preview"' "$session_dir/metadata.json"
        echo ""
    fi
    
    echo -e "${CYAN}Files:${NC} $session_dir/"
    ls -la "$session_dir/" | grep -v "^total"
}

cmd_stats() {
    echo -e "${BLUE}${BOLD}=== Archive Statistics ===${NC}"
    echo ""
    
    ensure_db
    
    if [ -f "$DB_FILE" ]; then
        total=$(sqlite3 "$DB_FILE" "SELECT COUNT(*) FROM sessions;")
        total_msgs=$(sqlite3 "$DB_FILE" "SELECT SUM(user_messages) FROM sessions;")
        total_tools=$(sqlite3 "$DB_FILE" "SELECT SUM(tool_calls) FROM sessions;")
        
        echo -e "${CYAN}Total sessions:${NC} $total"
        echo -e "${CYAN}Total user messages:${NC} $total_msgs"
        echo -e "${CYAN}Total tool calls:${NC} $total_tools"
        echo ""
        
        total_size=$(du -sh "$ARCHIVE_DIR" 2>/dev/null | cut -f1)
        echo -e "${CYAN}Archive size:${NC} $total_size"
        echo -e "${CYAN}Location:${NC} $ARCHIVE_DIR"
    else
        total_sessions=$(find "$ARCHIVE_DIR" -maxdepth 1 -type d | wc -l)
        total_sessions=$((total_sessions - 1))
        total_size=$(du -sh "$ARCHIVE_DIR" 2>/dev/null | cut -f1)
        
        echo "Total sessions: $total_sessions"
        echo "Archive size: $total_size"
        echo "Location: $ARCHIVE_DIR"
    fi
}

cmd_export() {
    session="$1"
    format="${2:-md}"
    
    if [ -z "$session" ]; then
        echo "Usage: sessions export <session-name> [format]"
        echo "Formats: md (default), json, txt"
        return 1
    fi
    
    session_dir="$ARCHIVE_DIR/$session"
    
    if [ ! -d "$session_dir" ]; then
        matches=$(ls -d "$ARCHIVE_DIR"/*"$session"* 2>/dev/null | head -1)
        if [ -n "$matches" ]; then
            session_dir="$matches"
            session=$(basename "$session_dir")
        else
            echo "Session not found: $session"
            return 1
        fi
    fi
    
    transcript="$session_dir/transcript.jsonl"
    output_file="${session}_export.${format}"
    
    case "$format" in
        md|markdown)
            echo "# Claude Code Session Export: $session" > "$output_file"
            echo "" >> "$output_file"
            echo "Exported: $(date)" >> "$output_file"
            echo "" >> "$output_file"
            
            if [ -f "$session_dir/summary.txt" ]; then
                echo "## Summary" >> "$output_file"
                cat "$session_dir/summary.txt" >> "$output_file"
                echo "" >> "$output_file"
            fi
            
            echo "## Conversation" >> "$output_file"
            echo "" >> "$output_file"
            
            jq -r '
                if .type == "user" or .type == "user_message" then
                    "### User\n\n" + (.content // "[no content]") + "\n"
                elif .type == "assistant" or .type == "assistant_message" then
                    "### Claude\n\n" + (.content // "[no content]") + "\n"
                elif .type == "tool_use" then
                    "### Tool: " + (.tool_name // "unknown") + "\n\n```json\n" + (.tool_input | tostring)[0:500] + "\n```\n"
                else
                    empty
                end
            ' "$transcript" >> "$output_file" 2>/dev/null
            ;;
        json)
            jq -s '.' "$transcript" > "$output_file"
            ;;
        txt)
            jq -r '
                if .type == "user" or .type == "user_message" then
                    "USER: " + (.content // "")
                elif .type == "assistant" or .type == "assistant_message" then
                    "CLAUDE: " + (.content // "")
                elif .type == "tool_use" then
                    "TOOL[" + .tool_name + "]: " + (.tool_input | tostring)[0:200]
                else
                    empty
                end
            ' "$transcript" > "$output_file" 2>/dev/null
            ;;
        *)
            echo "Unknown format: $format"
            return 1
            ;;
    esac
    
    echo -e "${GREEN}Exported to: $output_file${NC}"
}

cmd_reindex() {
    echo "Reindexing all sessions..."
    "$DB_MANAGER" init
    "$DB_MANAGER" reindex
    echo -e "${GREEN}Reindex complete!${NC}"
}

cmd_continue() {
    session="$1"
    if [ -z "$session" ]; then
        echo "Usage: sessions continue <session-name>"
        echo "Use 'sessions list' to see available sessions"
        return 1
    fi

    # Find the session
    session_dir="$ARCHIVE_DIR/$session"

    if [ ! -d "$session_dir" ]; then
        matches=$(ls -d "$ARCHIVE_DIR"/*"$session"* 2>/dev/null | head -1)
        if [ -n "$matches" ]; then
            session_dir="$matches"
            session=$(basename "$session_dir")
        else
            echo "Session not found: $session"
            return 1
        fi
    fi

    # Check for credits
    if ! type check_credits_for_restore &>/dev/null || ! check_credits_for_restore; then
        return 1
    fi

    # Use a credit
    remaining=$(perform_restore_with_credit)
    if [ $? -ne 0 ]; then
        return 1
    fi

    echo -e "${BLUE}${BOLD}=== Restoring Session: $session ===${NC}"
    echo ""

    # Generate continuation context
    PREPARE_SCRIPT="$HOME/.claudesessions/skills/scripts/prepare-continuation.sh"
    if [ -f "$PREPARE_SCRIPT" ]; then
        "$PREPARE_SCRIPT" "$session_dir"
    else
        # Fallback: show summary and key info
        if [ -f "$session_dir/summary.txt" ]; then
            echo -e "${CYAN}Session Summary:${NC}"
            cat "$session_dir/summary.txt"
            echo ""
        fi

        if [ -f "$session_dir/key-points.txt" ]; then
            echo -e "${CYAN}Key Points:${NC}"
            cat "$session_dir/key-points.txt"
            echo ""
        fi
    fi

    echo ""
    echo -e "${GREEN}Session context loaded.${NC}"
    show_credit_status
}

cmd_activate() {
    key="$1"
    if [ -z "$key" ]; then
        echo "Usage: sessions activate <license-key>"
        echo ""
        echo "Get your key at: https://claudesessions.com/buy"
        return 1
    fi

    if type activate_key &>/dev/null; then
        activate_key "$key"
    else
        echo -e "${RED}Credits library not found.${NC}"
        echo "Please reinstall Claude Sessions."
        return 1
    fi
}

cmd_credits() {
    if type show_credits &>/dev/null; then
        show_credits
    else
        echo "Credits library not found."
        echo "Please reinstall Claude Sessions."
        return 1
    fi
}

cmd_help() {
    echo -e "${BLUE}${BOLD}Claude Sessions - Never Lose Context${NC}"
    echo ""
    echo "Usage: sessions <command> [args]"
    echo ""
    echo -e "${CYAN}Free Commands:${NC}"
    echo "  list              List all archived sessions"
    echo "  search <query>    Full-text search across sessions"
    echo "  view <session>    View session details and summary"
    echo "  stats             Show archive statistics"
    echo "  export <session>  Export session (formats: md, json, txt)"
    echo "  reindex           Rebuild search index"
    echo ""
    echo -e "${CYAN}Pro Commands:${NC}"
    echo "  continue <session>  Restore session context (uses 1 credit)"
    echo "  credits             Show your credit balance"
    echo "  activate <key>      Activate a license key"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo "  sessions list"
    echo "  sessions search 'React component'"
    echo "  sessions view my-project-checkpoint"
    echo "  sessions continue my-project-checkpoint"
    echo "  sessions activate cs_Xk9mP2nQ4rT6vW8y"
    echo ""
    echo -e "${CYAN}Get credits:${NC} https://claudesessions.com/buy"
}

# === MAIN ===
case "${1:-list}" in
    list)       cmd_list ;;
    search)     cmd_search "$2" ;;
    view)       cmd_view "$2" ;;
    stats)      cmd_stats ;;
    export)     cmd_export "$2" "$3" ;;
    reindex)    cmd_reindex ;;
    continue)   cmd_continue "$2" ;;
    activate)   cmd_activate "$2" ;;
    credits)    cmd_credits ;;
    help|-h|--help)  cmd_help ;;
    *)          cmd_help ;;
esac
